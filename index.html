<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>지구는 내 거야!</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 0;
      background-image: url('background.png');
      background-size: cover;            /* 화면을 꽉 채움 */
      background-position: center;       /* 가운데 정렬 */
      background-repeat: no-repeat;      /* 반복하지 않음 */
      background-attachment: fixed;      /* 스크롤해도 고정된 배경 (선택) */
      margin: 0;
  padding: 0;
  height: 100%;
  overflow: auto;
}
    #startScreen {
      padding: 20px;
    }
  
#gameContainer {
  display: flex;
  flex-direction: column;
  align-items: center;
  height: 100%;
  overflow-y: auto; /* 점수판만 스크롤됨 */
}

#mainArea {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 100%;
  height: 100vh; /* 전체 화면 높이 */
  box-sizing: border-box;
  overflow: hidden;
}

#grid {
  display: grid;
  grid-template-columns: repeat(10, 1fr);
  grid-template-rows: repeat(10, 1fr);
  gap: 2px;
  width: 100vw;
  height: 90vh; /* 화면의 90%만 사용해서 격자판 표시 */
  box-sizing: border-box;
}

.cell {
  background: #eee;
  border: 1px solid #999;
  font-size: 1.8vmin;
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 4px;
  word-break: break-word;
  text-align: center;
  box-sizing: border-box;
  height: 100%;   /* 각 셀의 높이는 자동으로 결정됨 */
  width: 100%;
}

#scorePanel {
  flex-shrink: 0;
  width: 100%;
  display: flex !important;
  flex-direction: column;
  overflow-x: auto;
  padding: 20px;
  box-sizing: border-box;
  background-color: white; /* 배경 흰색 */
  border-radius: 8px;
  text-align: center;
  user-select: none;
  border-top: 4px solid #999;
  border-bottom: 4px solid #999;
  z-index: 10;
  font-size: 18px;
}

#scoreTable {
  width: 100%;
  border-collapse: collapse;
  margin: 0 auto;
}

#scoreTable th, #scoreTable td {
  border: 2px solid #999;
  padding: 14px;
  text-align: center;
  font-weight: bold;
  min-width: 100px;
  font-size: 20px;
  background-color: white;
}

.colorBox {
  display: inline-block;
  width: 20px;
  height: 20px;
  border-radius: 4px;
  margin-right: 6px;
  vertical-align: middle;
}

    #endGameButton {
      display: block;
      width: 100%;
      padding: 10px 0;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      background-color: #dc3545;
      color: white;
      cursor: pointer;
      transition: background-color 0.3s;
      user-select: none;
    }
    #endGameButton:hover {
      background-color: #a71d2a;
    }

    .popup, .difficulty-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fefefe;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      padding: 24px;
      z-index: 100;
      width: 400px;
      text-align: center;
      display: none;
    }
    .difficulty-popup p {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 20px;
    }
    .difficulty-popup button {
      margin: 8px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .difficulty-popup button:nth-child(2) {
      background-color: #28a745;
      color: white;
    }
    .difficulty-popup button:nth-child(2):hover {
      background-color: #1e7e34;
    }
    .difficulty-popup button:nth-child(3) {
      background-color: #007bff;
      color: white;
    }
    .difficulty-popup button:nth-child(3):hover {
      background-color: #0056b3;
    }
    .difficulty-popup button:nth-child(4) {
      background-color: #dc3545;
      color: white;
    }
    .difficulty-popup button:nth-child(4):hover {
      background-color: #a71d2a;
    }
    .popup button, .difficulty-popup button {
      margin: 5px;
      padding: 8px 15px;
      font-size: 16px;
      cursor: pointer;
    }
    #specialText {
      margin-top: 10px;
      font-weight: bold;
      color: #d9534f;
    }

    /* 조 이름 입력칸 디자인 및 숨김 (처음엔 숨김) */
    #nameInputs {
      display: none;
      margin-top: 290px;
    }
    .playerName {
      font-size: 24px;
      padding: 12px 20px;
      border-radius: 20px;
      border: 2px solid #ccc;
      width: 300px;
      margin: 5px auto;
      display: block;
      box-sizing: border-box;
      text-align: center;
    }

    /* 시작 버튼 디자인 (가운데 정렬) */
    #startButton {
      font-size: 32px;
      padding: 15px 40px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      background-color: #fffafa;
      color: black;
      font-weight: bold;
      transition: background-color 0.3s;
      user-select: none;
      margin-top: 440px;
    }
    #startButton:hover {
      background-color: #7b071f;
    }
    @keyframes explode {
  0% {
    transform: scale(0.5);
    opacity: 0;
    text-shadow: 0 0 10px red;
  }
  50% {
    transform: scale(2.5);
    opacity: 1;
    text-shadow: 0 0 40px orange, 0 0 80px yellow;
  }
  100% {
    transform: scale(1);
    opacity: 0;
    text-shadow: none;
  }
}

#questionPopup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 40px;        /* 안쪽 여백 크게 */
  border: 3px solid black;
  border-radius: 15px;
  width: 80%;           /* 가로 더 크게 */
  max-width: 1000px;    /* 최대 가로 크기 */
  height: auto;
  font-size: 1.8em;     /* 전체 글자 크기 키움 */
  z-index: 1000;
}

.material-box {
  border: 1px solid #999;
  padding: 10px;
  margin: 10px 0;
  background: #f9f9f9;
}

.source {
  text-align: right;
  font-size: 0.9em;
  color: #555;
}

.fullscreen-answer {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(255,255,255,0.95);
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 5em;
  font-weight: bold;
  color: red;
  z-index: 2000;
}

.answer-box {
  margin-top: 20px;
  font-size: 2em;
  font-weight: bold;
  color: red;
  text-align: center;
}

#choicesContainer {
  margin-top: 20px;   /* 문제와 보기 사이 간격 */
  display: grid;
  grid-template-columns: 1fr 1fr;  /* 보기 2개씩 가로 배치 */
  gap: 15px;          /* 보기 간격 */
}

#choicesContainer button {
  font-size: 1.2em;   /* 보기 글자 크기 키움 */
  padding: 15px;      /* 보기 버튼 크기 키움 */
  border-radius: 10px;
  border: 2px solid #333;
  cursor: pointer;
}

#questionText {
  font-size: 2em;   /* ← 문제 글씨 크게 */
  margin-bottom: 20px;
}

#explosionEffect {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 100px;
  color: #ff4444;
  z-index: 9999;
  display: none;
  pointer-events: none;
  animation: explode 1s ease-out;
}
  </style>
</head>
<body>
  <div id="startScreen">
    <!-- 시작 버튼만 먼저 보임 -->
    <button id="startButton">시작</button>
    
    <!-- 조 이름 입력칸 (처음엔 숨김) -->
    <div id="nameInputs">
      <input type="text" placeholder="1조" class="playerName" />
      <input type="text" placeholder="2조" class="playerName" />
      <input type="text" placeholder="3조" class="playerName" />
      <input type="text" placeholder="4조" class="playerName" />
      <input type="text" placeholder="5조" class="playerName" />
      <input type="text" placeholder="6조" class="playerName" />
    </div>
  </div>

  <div id="gameContainer">
    <div id="mainArea">
      <div id="turnDisplay"></div>
      <div id="grid"></div>
    </div>

    <table id="scoreTable">
  <thead>
    <tr id="scoreHeaderRow"><th>조 이름</th></tr>
  </thead>
  <tbody>
    <tr id="scoreDataRow"><th>점수</th></tr>
  </tbody>
</table>
      <button id="endGameButton" onclick="endGame()">게임 종료</button>
    </div>
  </div>
  <div id="scorePanel" style="margin-top: 20px;">
  </div>

  <div class="difficulty-popup" id="difficultyPopup">
    <p>난이도를 선택하세요:</p>
    <button onclick="selectDifficulty('하')">하</button>
    <button onclick="selectDifficulty('중')">중</button>
    <button onclick="selectDifficulty('상')">상</button>
  </div>

<!-- 문제 팝업 -->
<div id="questionPopup" style="display:none;">
  <div id="optionsContainer"></div>
  <div id="questionPopup" class="popup">
  <div id="questionText"></div>
  <div id="optionsContainer"></div> <!-- 보기 출력 영역 -->
  <button id="questionPopupAnswer">정답 보기</button>
  <button id="questionPopupClose">닫기</button>
</div>

  <!-- 문제 -->
  <p id="questionText" style="font-size: 24px; font-weight: bold;"></p>

  <!-- 자료 박스 -->
  <div id="materialBox" style="border: 2px solid #444; padding: 10px; margin: 10px 0; background:#f9f9f9;">
    <p id="questionResource" style="font-size:18px; margin:0;"></p>
    <p id="questionSource" style="text-align:right; font-size:14px; margin:0; color:#666;"></p>
  </div>

  <!-- 보기 (있으면 표시됨) -->
  <div id="choicesContainer" style="display:flex; flex-direction:column; gap:8px; margin:10px 0;">
    <button id="choice1" onclick="answerMultipleChoice(0)"></button>
    <button id="choice2" onclick="answerMultipleChoice(1)"></button>
    <button id="choice3" onclick="answerMultipleChoice(2)"></button>
    <button id="choice4" onclick="answerMultipleChoice(3)"></button>
  </div>

  <!-- 정답/오답 버튼 -->
  <div style="margin-top:15px;">
    <button onclick="handleAnswer(true)" style="padding:10px 20px; font-size:18px;">정답</button>
    <button onclick="handleAnswer(false)" style="padding:10px 20px; font-size:18px;">오답</button>
  </div>
</div>

<!-- 정답 표시 박스 -->
  <div id="answerDisplay" style="display:none;">
    <span id="correctAnswer"></span>
  </div>

<div id="fullscreenAnswer" class="fullscreen-answer" style="display:none;"></div>

  <div class="popup" id="rankingPopup">
    <h3>게임 결과</h3>
    <div id="rankingList" style="text-align: left; margin: 10px 0;"></div>
    <button onclick="closeRankingPopup()">닫기</button>
  </div>

  <!-- 음악 오디오 (파일 경로 확인 필요) -->
  <audio id="bgm" src="the_motion.mp3"></audio>
  <audio id="startSound" src="start.mp3"></audio>
  <audio id="correctSound" src="correct.mp3" preload="auto"></audio><audio id="wrongSound" src="wrong.mp3" preload="auto"></audio>
  <audio id="specialSound" src="special.mp3" preload="auto"></audio>

  <script>
    let questionsFromSheet = [];
    let question;

async function loadQuestions() {
// 이제 오류 안 남
console.log(questionsFromSheet.length);
}
    // ===== 기존 스크립트 유지 =====
    const players = [];
    const playerColors = ["red", "orange", "yellow", "green", "blue", "purple"];
    let currentPlayer = 0;
    const usedQuestions = {}; // 예: { '개봉-하': true }
    const cities = [
      "청주", "개봉", "교토", "가오", "뉴욕", "강화도", "광저우", "나가사키", "수마트라", "브뤼셀",
      "개성", "낙양", "나라", "델포이", "우한", "경주", "난징", "도쿄", "런던", "자카르타",
      "공주", "성도", "오사카", "로마", "히로시마", "광주", "베이징", "카라코룸", "베를린", "캄차카반도",
      "김제", "니스", "하노이", "리우데자네이루", "사라예보", "김해", "양저우", "뉴델리", "메카", "오시비엥침",
      "나주", "영가", "콜카타", "멤피스", "크라스노야르스크", "대구", "장안", "앙코르", "바티칸", "함부르크",
      "남양주", "톈진", "카트만두", "베네치아", "논산", "충칭", "키이우", "보스턴", "페르세폴리스", "항저우",
      "오키나와", "당진", "빈", "서울", "상트페테르부르크", "대마도", "아바나", "상주", "아비뇽", "울산",
      "아헨", "원산", "악숨", "서천", "에든버러", "영주", "예루살렘", "인천", "울룬디", "영흥",
      "워싱턴 D.C.", "제주도", "음반자콩구", "진주", "제네바", "철원", "카르타고", "곡산", "캔버라", "의령",
      "상하이", "천안", "이스탄불", "평양", "쿠스코", "함양", "테노치티틀란", "톨레도", "파리", "부산"
    ];

    const specialCities = {
      "수마트라": "비상! 대지진 발생!",
      "오키나와": "비상! 지진 발생!",
      "우한": "앗 비상! 코로나 창궐!",
      "자카르타": "비상! 홍수 발생!",
      "히로시마": "비상! 하늘에 핵폭탄이!",
      "캄차카반도": "비상! 화산 폭발!",
      "사라예보": "탕!",
      "오시비엥침": "비상! 독일이 수용소로 사람들을 끌고 간다!",
      "크라스노야르스크": "비상! 퉁구스카 대폭발 발생!",
      "함부르크": "앗 비상! 콜레라 창궐!"
    };

    const startPositionsIndexes = [0, 9, 90, 99, 4, 95];
    const startPositions = startPositionsIndexes.map(i => cities[i]);

    const fixedQuestions = {
      하: cities.reduce((acc, city, i) => {
        if(city) acc[city] = `${city} 하 난이도 문제 예시 ${i + 1}`;
        return acc;
      }, {}),
      중: cities.reduce((acc, city, i) => {
        if(city) acc[city] = `${city} 중 난이도 문제 예시 ${i + 1}`;
        return acc;
      }, {})
    };

    const hardQuestions = [
      "상 난이도 문제 예시 1",
      "상 난이도 문제 예시 2",
      "상 난이도 문제 예시 3",
      "상 난이도 문제 예시 4",
      "상 난이도 문제 예시 5"
    ];

    let selectedCity = "";
    let selectedDifficulty = "";  // 난이도 저장용
    let currentQuestion = null; // 현재 문제 전역 변수

   function openDifficultyPopup(city) {
  selectedCity = city;

  const levels = ["하", "중", "상"];
  levels.forEach((level, index) => {
    const button = document.querySelector(`#difficultyPopup button:nth-child(${index + 2})`);
    const key = `${city}-${level}`;
    if (usedQuestions[key]) {
      button.disabled = true;
      button.style.backgroundColor = "#ccc";
      button.style.cursor = "not-allowed";
      button.style.color = "#666";
    } else {
      button.disabled = false;

      // 원래 스타일 복원
      if (level === "하") {
        button.style.backgroundColor = "#28a745"; // 기본
        button.style.color = "white";
      } else if (level === "중") {
        button.style.backgroundColor = "#007bff";
        button.style.color = "white";
      } else if (level === "상") {
        button.style.backgroundColor = "#dc3545";
        button.style.color = "white";
      }
      button.style.cursor = "pointer";
    }
  });

  document.getElementById("difficultyPopup").style.display = "block";
}

    function selectDifficulty(level) {
  selectedDifficulty = level;    // 난이도 저장
  document.getElementById("difficultyPopup").style.display = "none";

  const key = `${selectedCity}-${level}`;
  if (usedQuestions[key]) {
    alert("이미 푼 문제입니다!");
    return;
  }
  usedQuestions[key] = true;  // 사용 기록 저장

  question = "";
  if (level === "상") {
    question = hardQuestions[Math.floor(Math.random() * hardQuestions.length)];
  } else {
    question = fixedQuestions[level][selectedCity];
  }

  if (!question) {
    alert("문제가 존재하지 않습니다!");
    return;
  }

  showQuestion(question);
}
function showQuestion(question) {
  document.getElementById("questionText").textContent = question;
  document.getElementById("questionPopup").style.display = "block";
  document.getElementById("materialBox").style.display = "none"; // 기본 숨김
  document.getElementById("choicesContainer").style.display = "none"; // 기본 숨김

  // 1. 문제 찾기
  question = questionsFromSheet.find(
    q => q.도시명 === city && q.난이도 === difficulty
  );

  if (!question) {
    console.error("문제를 찾을 수 없습니다:", city, difficulty);
    return;
  }
  console.log(questionsFromSheet.find(q => q.도시명 === city && q.난이도 === difficulty));
  if (question.options && typeof question.options === "string") {
  question.options = question.options.split(",").map(opt => opt.trim());
}

    // 2. 문제 텍스트 표시
  const questionContainer = document.getElementById("questionContainer");
  if (questionContainer) {
    questionContainer.innerHTML = question.문제;
  } else {
    console.error("questionContainer 요소를 찾을 수 없습니다.");
  }

  // 문제 텍스트
    document.getElementById("questionText").innerText = question.question || "";
     if (question.resource) {
    document.getElementById("materialBox").style.display = "block";
    document.getElementById("questionResource").innerText = question.resource;
    document.getElementById("questionSource").innerText = question.source || "";
  } else {
    document.getElementById("materialBox").style.display = "none";
  }

  // 자료 + 출처
  document.getElementById("material").textContent = question.material || "";
  document.getElementById("source").textContent = question.source || "";
 if (question.자료) {
    document.getElementById("materialBox").style.display = "block";
    document.getElementById("questionResource").innerText = question.자료;
    document.getElementById("questionSource").innerText = question["자료 출처"] || "";
  } else {
    document.getElementById("materialBox").style.display = "none";
  }

  // 보기 (없으면 버튼 숨김)
  let choices = [question.보기1, question.보기2, question.보기3, question.보기4];
  for (let i = 0; i < 4; i++) {
    let btn = document.getElementById("choice" + (i + 1));
    if (choices[i]) {
      btn.style.display = "inline-block";
      btn.innerText = choices[i];
    } else {
      btn.style.display = "none";
    }
  }
  
  // 정답 영역은 항상 숨김 (처음 문제 보여줄 때)
  document.getElementById("answerDisplay").style.display = "none";

    // 팝업 보이기
    document.getElementById("questionPopup").style.display = "block";
}

  let questionsLoaded = false;

window.addEventListener("load", async () => {
  await loadQuestions();
  questionsLoaded = true; // 로드 완료 표시
});

// 정답/오답 버튼 누르면 실행
function checkAnswer(isCorrect) {
  // 정답 표시
  document.getElementById("answerDisplay").style.display = "block";
  document.getElementById("correctAnswer").innerText = questionPopupAnswer;

  // 점수 반영
  if (isCorrect) {
    if (currentQuestion.난이도 === "하") playerscores[currentPlayer] += 1;
    if (currentQuestion.난이도 === "중") playerscores[currentPlayer] += 2;
    if (currentQuestion.난이도 === "상") playerscores[currentPlayer] += 3;
  }
  updateScoreboard();
}

  // 보기 출력 (일렬)
  const optionsContainer = document.getElementById("optionsContainer");
  optionsContainer.innerHTML = "";
  if (question && question.options && question.options.length > 0) {
  question.options.forEach(opt => {
    const btn = document.createElement("button");
    btn.textContent = opt;
    btn.className = "option-btn";
    optionsContainer.appendChild(btn);
  });
} else {
  console.warn("보기 옵션이 존재하지 않습니다:", question);
}
  
  if (question.보기 && question.보기.length > 0) {
    document.getElementById("choicesContainer").style.display = "block";
    question.보기.forEach((choice, i) => {
      document.getElementById("choice"+(i+1)).innerText = choice;
    });
  } else {
    document.getElementById("choicesContainer").style.display = "none";
  }

  // 팝업 보이기
  document.getElementById("questionPopup").style.display = "block";

  // 정답 숨김
  document.getElementById("answerBox").style.display = "none";
  document.getElementById("correctAnswer").textContent = question.answer;

  document.getElementById("questionPopup").style.display = "block";

function markAnswer(isCorrect) {
  const answerText = isCorrect ? "정답!" : "오답!";
  const answerBox = document.getElementById("fullscreenAnswer");
  answerBox.innerText = answerText;
  answerBox.style.display = "flex";

  setTimeout(() => {
    answerBox.style.display = "none";
    document.getElementById("questionPopup").style.display = "none";
  }, 2000);

  // 점수 추가 (예시: 난이도 하=1, 중=2, 상=3)
  if (isCorrect) {
    let scoreToAdd = 1; // 기본 하 난이도
    if (selectedDifficulty === "중") scoreToAdd = 2;
    if (selectedDifficulty === "상") scoreToAdd = 3;
    playerscores[selectedDifficulty] += scoreToAdd;
  }

  nextTurn();
}

// 정답 / 오답 버튼
// 정답/오답 버튼 클릭 처리
function handleAnswer(isCorrect) {
  const answerOverlay = document.getElementById("answerOverlay");

  if (isCorrect) {
    answerOverlay.innerText = "정답!";

    // 점수 추가 (난이도에 따라 점수 계산)
    let scoreToAdd = 0;
    if (selectedDifficulty === "하") scoreToAdd = 1;
    if (selectedDifficulty === "중") scoreToAdd = 2;
    if (selectedDifficulty === "상") scoreToAdd = 3;

    playerscores[currentPlayer] += scoreToAdd;
    updateScoreboard();
  } else {
    answerOverlay.innerText = "오답!";
  }

  // 정답/오답 화면 표시
  answerOverlay.style.display = "flex";

  // 2초 후 닫기
  setTimeout(() => {
    answerOverlay.style.display = "none";
    closeQuestionPopup();
  }, 2000);
}

    function answerQuestion(correct) {
  document.getElementById("questionPopup").style.display = "none";

  const cells = document.querySelectorAll(".cell"); // 여기 선언 필요

  if (correct) {
    const correctSound = document.getElementById("correctSound");
    correctSound.volume = 0.6;
    correctSound.play().catch(err => {
      console.log("정답 효과음 재생 실패:", err);
    });

    let points = 0;
    if (selectedDifficulty === "하") points = 1;
    else if (selectedDifficulty === "중") points = 2;
    else if (selectedDifficulty === "상") points = 3;

    playerscores[players[currentPlayer]] += points;

    cells.forEach(cell => {
      if (cell.textContent.trim() === selectedCity) {
        cell.style.backgroundColor = playerColors[currentPlayer];
        cell.style.color = "white";
        cell.style.fontWeight = "bold";
      }
    });

    updateScoreTable();
  } else {
    const wrongSound = document.getElementById("wrongSound");
    wrongSound.volume = 0.6;
    wrongSound.play().catch(err => {
      console.log("오답 효과음 재생 실패:", err);
    });
  }

  currentPlayer = (currentPlayer + 1) % players.length;
  updateTurnDisplay();

}

    const playerscores = {};

      // ===== 구글 시트에서 불러온 문제 저장 =====
  async function loadQuestions() {
    const url = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQUv4xOGCdaDnzuT6kxXcldcEVDnxc6g1rhpG2rkcE_Rq_MR-w946zTjv0d62Uu6aVKgEA7OKjapyUI/pub?output=csv'; // 여기에 CSV 공개 링크 입력
    const response = await fetch(url);
    const data = await response.text();

    // PapaParse로 CSV 파싱
  const parsed = Papa.parse(data, { header: true, skipEmptyLines: true });

  questionsFromSheet = parsed.data.map(row => ({
    city: row.도시명 || row.city,
    difficulty: row.난이도 || row.difficulty,
    question: row.문제 || row.question,
    resource: row.자료 || row.resource,
    source: row['자료 출처'] || row.source,
    answer: row.답 || row.answer,
    choice1: row.보기1 || row.choice1,
    choice2: row.보기2 || row.choice2,
    choice3: row.보기3 || row.choice3,
    choice4: row.보기4 || row.choice4
  }));

   console.log("문제 불러오기 완료:", questionsFromSheet);
  console.log('파싱된 문제:', questionsFromSheet);

    const rows = data.split('\n').slice(1); // 헤더 제외
    rows.forEach(row => {
  const [city, difficulty, question, resource, source, answer, choice1, choice2, choice3, choice4] = row.split(',');
  if(city && difficulty && question) {
    questionsFromSheet.push({ city, difficulty, question, resource, source, answer, choice1, choice2, choice3, choice4 });
  }
});
    console.log('문제 불러오기 완료:', questionsFromSheet);

  // 헤더 제외하고 데이터 저장
  questions = rows.slice(1).map(r => ({
    city: r[1],
    level: r[2],
    question: r[3],
    source: r[5],
    answer: r[6]
  }));

  console.log("파싱된 문제:", questions);
  }

  window.addEventListener("load", async () => {
    await loadQuestions();
  });

  // ===== 난이도 선택 후 문제 보여주기 =====

    function startGame() {
      window.addEventListener("load", async () => {
  await loadQuestions();
  questionsLoaded = true; // 여기가 한 번만 실행되도록
});

   document.getElementById("startScreen").style.display = "none"; 
 const inputs = document.querySelectorAll(".playerName");
  players.length = 0; 
  inputs.forEach(input => {
    const name = input.value.trim();
    if (name) players.push(name);
  });

  if (players.length < 1) {
    alert("최소 1명의 플레이어가 필요합니다!");
    return;
  }

// playerScores 초기화
      for (const key in playerscores) delete playerscores[key];
      players.forEach(p => {
        playerscores[p] = 0;
        currentPlayer = 0;
      });

  // 게임 화면 표시
  document.getElementById("gameContainer").style.display = "flex";
  document.getElementById("scorePanel").classList.add("show"); // 점수판 보이기

  drawBoard();
  updateTurnDisplay();
  updateScoreTable();

  // 배경 변경
  document.body.style.backgroundImage = "none";
  document.body.style.backgroundColor = "black";

      // 효과음 재생
const startSound = document.getElementById("startSound");
startSound.play().catch(err => {
  console.log("시작 효과음 재생 실패:", err);
});
    }

    function showSpecialEvent(city) {
      selectedCity = city;
      selectedDifficulty = "하"; // 점수를 위해 난이도는 하로 고정
      document.getElementById("questionText").textContent = "";
      document.getElementById("specialText").textContent = specialCities[city];
      document.getElementById("questionPopup").style.display = "block";
      selectedCity = city;
  selectedDifficulty = "하"; // 점수를 위해 난이도는 하로 고정
  document.getElementById("questionText").textContent = "";
  document.getElementById("specialText").textContent = specialCities[city];
  document.getElementById("questionPopup").style.display = "block";

  // 🎵 특수 효과음 재생
  const specialSound = document.getElementById("specialSound");
  specialSound.play().catch(err => {
    console.log("특수 효과음 재생 실패:", err);
  });
    }

    let questionPopupAnswer = ""; // 정답 저장용

function answerMultipleChoice(choiceIndex) {
  const selectedBtn = document.getElementById(`choice${choiceIndex+1}`);
  const selectedText = selectedBtn.textContent;

  const correct = selectedText === questionPopupAnswer;

  answerQuestion(correct); // 기존 answerQuestion 재사용  
}

    function drawBoard() {
      const grid = document.getElementById("grid");
      grid.innerHTML = "";
      cities.forEach((city, idx) => {
        const cell = document.createElement("div");
        cell.className = "cell";
        cell.textContent = city;
        cell.onclick = () => {
          if (specialCities[city]) {
            showSpecialEvent(city);
          } else {
            openDifficultyPopup(city);
          }
        };
        const startIndex = startPositions.indexOf(city);
        if (startIndex !== -1 && startIndex < players.length) {
          cell.style.backgroundColor = playerColors[startIndex];
          cell.style.color = "white";
          cell.style.fontWeight = "bold";
        }
        grid.appendChild(cell);
      });
    }

  function updateScoreTable() {
  const headerRow = document.getElementById("scoreHeaderRow");
  const dataRow = document.getElementById("scoreDataRow");

  headerRow.innerHTML = "<th>조명</th>";
  dataRow.innerHTML = "<th>점수</th>";

  players.forEach((player, idx) => {
    headerRow.innerHTML += `<th><span class="colorBox" style="background-color:${playerColors[idx]}"></span>${player}</th>`;
    dataRow.innerHTML += `<td>${playerscores[player]}</td>`;
  });
}

    function updateTurnDisplay() {
      if (players.length > 0) {
        document.getElementById("turnDisplay").textContent = `${players[currentPlayer]}`;
        document.getElementById("turnDisplay").style.color = playerColors[currentPlayer];
      }
    }
    function endGame() {
  // 💥 폭발 효과 실행
  const explosion = document.getElementById("explosionEffect");
  explosion.style.display = "block";
  explosion.style.animation = "explode 1s ease-out";

  // 1초 후 제거
  setTimeout(() => {
    explosion.style.display = "none";
  }, 1000);

  // 순위 계산
  let ranking = [...players];
  ranking.sort((a, b) => playerscores[b] - playerscores[a]);

  let rankingText = "";
  ranking.forEach((player, i) => {
    let fontSize = 36 - i * 4; // 1등: 36px → 2등: 32px ...
    if (fontSize < 16) fontSize = 16;

    let style = `
      font-size: ${fontSize}px;
      font-weight: ${i === 0 ? 'bold' : 'normal'};
      color: ${i === 0 ? '#d9534f' : '#222'};
      margin-bottom: 10px;
      text-align: center;
    `;
    rankingText += `<div style="${style}">${i + 1}위 ${player} - 점수: ${playerscores[player]}</div>`;
  });

  document.getElementById("rankingList").innerHTML = rankingText;
  document.getElementById("rankingPopup").style.display = "block";
}
   
    function closeRankingPopup() {
      document.getElementById("rankingPopup").style.display = "none";
    }

    // 시작 버튼 클릭 시 이름 입력칸 표시
    document.getElementById("startButton").addEventListener("click", () => {
    document.getElementById("startButton").style.display = "none";
    document.getElementById("nameInputs").style.display = "block";
});

      // ✅ 음악 재생
  const bgm = document.getElementById("bgm");
  bgm.volume = 0.3;     // 볼륨 조절 (0 ~ 1)
  bgm.loop = true;      // 반복 재생
  bgm.play().catch(err => {
    console.log("음악 자동 재생이 차단됨:", err);
  });

    // 조 이름 입력 완료 후 엔터 눌러도 게임 시작 가능
    document.querySelectorAll(".playerName").forEach(input => {
  input.addEventListener("keypress", e => {
    if (e.key === "Enter") {
      startGame();
    }
  });
});

    // 입력칸 6개 중 하나라도 변경되면 플레이어 이름 자동 업데이트
    document.querySelectorAll(".playerName").forEach(input => {
      input.addEventListener("input", () => {
        // 자동으로 플레이어 이름 갱신
        // (추가 구현 가능)
      });
    });
  </script>
  <div id="explosionEffect" style="display: none;">💥</div>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</body>
</html>